= GraalVM cli-app toy that sets slack profile name

== Step 2, reducing  size by removing micrometer dependencies

[source, shell]
----
$ ./gradlew :dependencies --configuration runtimeClasspath

> Task :dependencies

------------------------------------------------------------
Root project
------------------------------------------------------------

runtimeClasspath - Runtime classpath of source set 'main'.
+--- io.micronaut:micronaut-validation -> 2.1.4
|    +--- org.slf4j:slf4j-api:1.7.26
|    +--- io.micronaut:micronaut-inject:2.1.4
|    |    +--- org.slf4j:slf4j-api:1.7.26
|    |    +--- javax.annotation:javax.annotation-api:1.3.2
|    |    +--- javax.inject:javax.inject:1
|    |    +--- io.micronaut:micronaut-core:2.1.4
|    |    |    +--- org.slf4j:slf4j-api:1.7.26
|    |    |    +--- org.reactivestreams:reactive-streams:1.0.3
|    |    |    \--- com.github.spotbugs:spotbugs-annotations:4.0.3
|    |    |         \--- com.google.code.findbugs:jsr305:3.0.2
|    |    \--- org.yaml:snakeyaml:1.26
|    +--- io.micronaut:micronaut-http:2.1.4
|    |    +--- org.slf4j:slf4j-api:1.7.26
|    |    \--- io.micronaut:micronaut-inject:2.1.4 (*)
|    \--- javax.validation:validation-api:2.0.1.Final
+--- io.micronaut:micronaut-runtime -> 2.1.4
|    +--- org.slf4j:slf4j-api:1.7.26
|    +--- io.micronaut:micronaut-http:2.1.4 (*)
|    +--- io.micronaut:micronaut-inject:2.1.4 (*)
|    +--- io.micronaut:micronaut-aop:2.1.4
|    |    +--- org.slf4j:slf4j-api:1.7.26
|    |    +--- io.micronaut:micronaut-inject:2.1.4 (*)
|    |    \--- io.micronaut:micronaut-core:2.1.4 (*)
|    +--- javax.validation:validation-api:2.0.1.Final
|    +--- com.fasterxml.jackson.core:jackson-databind:2.11.2
|    |    +--- com.fasterxml.jackson.core:jackson-annotations:2.11.2
|    |    \--- com.fasterxml.jackson.core:jackson-core:2.11.2
|    +--- io.reactivex.rxjava2:rxjava:2.2.10
|    |    \--- org.reactivestreams:reactive-streams:1.0.2 -> 1.0.3
|    +--- com.fasterxml.jackson.datatype:jackson-datatype-jdk8:2.11.2
|    |    +--- com.fasterxml.jackson.core:jackson-core:2.11.2
|    |    \--- com.fasterxml.jackson.core:jackson-databind:2.11.2 (*)
|    \--- com.fasterxml.jackson.datatype:jackson-datatype-jsr310:2.11.2
|         +--- com.fasterxml.jackson.core:jackson-annotations:2.11.2
|         +--- com.fasterxml.jackson.core:jackson-core:2.11.2
|         \--- com.fasterxml.jackson.core:jackson-databind:2.11.2 (*)
+--- info.picocli:picocli -> 4.5.1
+--- io.micronaut.picocli:micronaut-picocli -> 3.0.0
|    +--- io.micronaut:micronaut-bom:2.0.1 -> 2.1.4
|    |    +--- io.micronaut.views:micronaut-views-bom:2.0.1
|    |    +--- io.micronaut.groovy:micronaut-groovy-bom:2.1.0
|    |    |    \--- org.codehaus.groovy:groovy-bom:3.0.3
|    |    +--- io.micronaut.test:micronaut-test-bom:2.1.1
|    |    |    +--- org.junit:junit-bom:5.7.0
|    |    |    \--- org.spockframework:spock-bom:2.0-M3-groovy-3.0
|    |    +--- io.micronaut.data:micronaut-data-bom:2.1.1
|    |    +--- io.micronaut.oraclecloud:micronaut-oraclecloud-bom:1.0.0
|    |    +--- io.netty:netty-bom:4.1.54.Final
|    |    +--- io.ktor:ktor-bom:1.4.0
|    |    +--- org.codehaus.groovy:groovy-bom:3.0.3
|    |    +--- io.micrometer:micrometer-bom:1.5.5
|    |    +--- org.junit:junit-bom:5.7.0
|    |    +--- com.fasterxml.jackson:jackson-bom:2.11.2
|    |    |    +--- com.fasterxml.jackson.core:jackson-databind:2.11.2 (c)
|    |    |    +--- com.fasterxml.jackson.datatype:jackson-datatype-jdk8:2.11.2 (c)
|    |    |    +--- com.fasterxml.jackson.datatype:jackson-datatype-jsr310:2.11.2 (c)
|    |    |    +--- com.fasterxml.jackson.core:jackson-annotations:2.11.2 (c)
|    |    |    \--- com.fasterxml.jackson.core:jackson-core:2.11.2 (c)
|    |    +--- io.grpc:grpc-bom:1.32.1
|    |    +--- com.google.protobuf:protobuf-bom:3.13.0
|    |    +--- io.micronaut:micronaut-inject:2.1.4 (c)
|    |    +--- io.micronaut:micronaut-runtime:2.1.4 (c)
|    |    +--- io.micronaut:micronaut-validation:2.1.4 (c)
|    |    +--- javax.annotation:javax.annotation-api:1.3.2 (c)
|    |    +--- io.micronaut.picocli:micronaut-picocli:3.0.0 (c)
|    |    +--- info.picocli:picocli:4.5.1 (c)
|    |    +--- ch.qos.logback:logback-classic:1.2.3 (c)
|    |    +--- org.slf4j:slf4j-api:1.7.26 (c)
|    |    +--- io.micronaut:micronaut-core:2.1.4 (c)
|    |    +--- org.yaml:snakeyaml:1.26 (c)
|    |    +--- io.micronaut:micronaut-http:2.1.4 (c)
|    |    +--- io.micronaut:micronaut-aop:2.1.4 (c)
|    |    +--- javax.validation:validation-api:2.0.1.Final (c)
|    |    +--- io.reactivex.rxjava2:rxjava:2.2.10 (c)
|    |    +--- org.reactivestreams:reactive-streams:1.0.3 (c)
|    |    +--- com.github.spotbugs:spotbugs-annotations:4.0.3 (c)
|    |    \--- com.google.code.findbugs:jsr305:3.0.2 (c)
|    +--- io.micronaut:micronaut-inject:2.0.1 -> 2.1.4 (*)
|    +--- io.micronaut:micronaut-runtime:2.0.1 -> 2.1.4 (*)
|    \--- info.picocli:picocli:4.5.1
+--- javax.annotation:javax.annotation-api -> 1.3.2
+--- io.micronaut:micronaut-inject -> 2.1.4 (*)
+--- io.micronaut:micronaut-bom:2.1.4 (*)
\--- ch.qos.logback:logback-classic -> 1.2.3
     +--- ch.qos.logback:logback-core:1.2.3
     \--- org.slf4j:slf4j-api:1.7.25 -> 1.7.26

(c) - dependency constraint
(*) - dependencies omitted (listed previously)

A web-based, searchable dependency report is available by adding the --scan option.

BUILD SUCCESSFUL in 1s
1 actionable task: 1 executed
----


Even if the project only added the asciidoctor and graalvm features,
there's a few dependencies by default.

Removing all explicit depencencies

.removing explicit depdencies
[source, diff]
----
     annotationProcessor("info.picocli:picocli-codegen:4.2.0")
     compileOnly("org.graalvm.nativeimage:svm")
-    implementation("io.micronaut:micronaut-validation")
-    implementation("io.micronaut:micronaut-runtime")
     implementation("info.picocli:picocli")
-    implementation("io.micronaut.picocli:micronaut-picocli")
-    implementation("javax.annotation:javax.annotation-api")
----


[source, shell]
----
$ ./gradlew :dependencies --configuration runtimeClasspath

> Task :dependencies

------------------------------------------------------------
Root project
------------------------------------------------------------

runtimeClasspath - Runtime classpath of source set 'main'.
+--- info.picocli:picocli -> 4.5.1
+--- io.micronaut:micronaut-inject -> 2.1.4
|    +--- org.slf4j:slf4j-api:1.7.26
|    +--- javax.annotation:javax.annotation-api:1.3.2
|    +--- javax.inject:javax.inject:1
|    +--- io.micronaut:micronaut-core:2.1.4
|    |    +--- org.slf4j:slf4j-api:1.7.26
|    |    +--- org.reactivestreams:reactive-streams:1.0.3
|    |    \--- com.github.spotbugs:spotbugs-annotations:4.0.3
|    |         \--- com.google.code.findbugs:jsr305:3.0.2
|    \--- org.yaml:snakeyaml:1.26
+--- io.micronaut:micronaut-bom:2.1.4
|    +--- io.micronaut.views:micronaut-views-bom:2.0.1
|    +--- io.micronaut.groovy:micronaut-groovy-bom:2.1.0
|    |    \--- org.codehaus.groovy:groovy-bom:3.0.3
|    +--- io.micronaut.test:micronaut-test-bom:2.1.1
|    |    +--- org.junit:junit-bom:5.7.0
|    |    \--- org.spockframework:spock-bom:2.0-M3-groovy-3.0
|    +--- io.micronaut.data:micronaut-data-bom:2.1.1
|    +--- io.micronaut.oraclecloud:micronaut-oraclecloud-bom:1.0.0
|    +--- io.netty:netty-bom:4.1.54.Final
|    +--- io.ktor:ktor-bom:1.4.0
|    +--- org.codehaus.groovy:groovy-bom:3.0.3
|    +--- io.micrometer:micrometer-bom:1.5.5
|    +--- org.junit:junit-bom:5.7.0
|    +--- com.fasterxml.jackson:jackson-bom:2.11.2
|    +--- io.grpc:grpc-bom:1.32.1
|    +--- com.google.protobuf:protobuf-bom:3.13.0
|    +--- io.micronaut:micronaut-inject:2.1.4 (c)
|    +--- info.picocli:picocli:4.5.1 (c)
|    +--- ch.qos.logback:logback-classic:1.2.3 (c)
|    +--- org.slf4j:slf4j-api:1.7.26 (c)
|    +--- javax.annotation:javax.annotation-api:1.3.2 (c)
|    +--- io.micronaut:micronaut-core:2.1.4 (c)
|    +--- org.yaml:snakeyaml:1.26 (c)
|    +--- org.reactivestreams:reactive-streams:1.0.3 (c)
|    +--- com.github.spotbugs:spotbugs-annotations:4.0.3 (c)
|    \--- com.google.code.findbugs:jsr305:3.0.2 (c)
\--- ch.qos.logback:logback-classic -> 1.2.3
     +--- ch.qos.logback:logback-core:1.2.3
     \--- org.slf4j:slf4j-api:1.7.25 -> 1.7.26

(c) - dependency constraint
(*) - dependencies omitted (listed previously)

A web-based, searchable dependency report is available by adding the --scan option.

BUILD SUCCESSFUL in 1s
1 actionable task: 1 executed
----

This leads to quite few ~ 16 MiB saved :

.lighter native image
[source, shell]
----
❯ ./gradlew nativeImage

> Task :compileJava
Note: ReflectConfigGen writing to: CLASS_OUTPUT/META-INF/native-image/picocli-generated/reflect-config.json
Note: ResourceConfigGen writing to: CLASS_OUTPUT/META-INF/native-image/picocli-generated/resource-config.json
Note: ProxyConfigGen writing to: CLASS_OUTPUT/META-INF/native-image/picocli-generated/proxy-config.json

> Task :nativeImage
[application:16014]    classlist:   1,525.12 ms,  0.96 GB
[application:16014]        (cap):   3,379.97 ms,  0.96 GB
[application:16014]        setup:   4,416.23 ms,  0.96 GB
[application:16014]     (clinit):     530.59 ms,  4.62 GB
[application:16014]   (typeflow):  14,808.15 ms,  4.62 GB
[application:16014]    (objects):  13,375.10 ms,  4.62 GB
[application:16014]   (features):     912.96 ms,  4.62 GB
[application:16014]     analysis:  30,346.45 ms,  4.62 GB
[application:16014]     universe:     926.49 ms,  4.62 GB
[application:16014]      (parse):   4,099.46 ms,  4.62 GB
[application:16014]     (inline):   7,206.29 ms,  5.38 GB
[application:16014]    (compile):  23,836.20 ms,  5.20 GB
[application:16014]      compile:  37,356.28 ms,  5.20 GB
[application:16014]        image:   3,355.86 ms,  5.20 GB
[application:16014]        write:     960.86 ms,  5.20 GB
[application:16014]      [total]:  79,031.79 ms,  5.20 GB
Native Image written to: /Users/bric3/opensource/slack-set-profile/build/native-image/application

BUILD SUCCESSFUL in 1m 22s
3 actionable tasks: 2 executed, 1 up-to-date
❯ ls -lah build/native-image/application
Permissions Size User  Date Modified Name
.rwxr-xr-x   38M bric3 18 Nov 23:04  build/native-image/application
----

== Step 1, adds simple HTTP read/write operation

The goal is to read or write to the slack user profile,
for that there's two subcommands

[source,java]
----
    @Command(name = "read-profile", description = "Read slack user profile")
    void readUserProfile() {
----

[source,java]
----
    @Command(name = "write-profile", description = "Read slack user profile")
    void writeUserProfile() {
----

They both use the JDK `HttpClient` introduced in JDK 11.
Let us see what it does to add two new picocli method subcommands
with `HttpClient` ?

.binary size with subcommands
[source, shell]
----
$  ls -lah build/native-image/application
Permissions Size User  Date Modified Name
.rwxr-xr-x   54M bric3 18 Nov 21:33  build/native-image/application
----

== Step 0, a walking skeleton

Use the micronaut command line starter to create the cli application

.Micronaut starter
[source, shell]
----
$ mn create-cli-app --features=graalvm,asciidoctor --jdk=11 slack-set-profile
| Application created at /Users/bric3/opensource/slack-set-profile
$ cd slack-set-profile
----

Then setup GraalVM for this project, I'm using https://asdf-vm.com/[asdf-vm]
with the https://github.com/halcyon/asdf-java[asdf-java plugin] to manage my
JDK versions. Then it's necessary to download the `native-image` binary using
the specific GraalVM `gu` tool.

.Use GraalVM with `native-image`
[source, shell]
----
$ asdf local java graalvm-20.3.0+java11
$ gu install native-image
Downloading: Component catalog from www.graalvm.org
Processing Component: Native Image
Downloading: Component native-image: Native Image  from github.com
Installing new component: Native Image (org.graalvm.native-image, version 20.3.0)
----

Since the micronaut starter generated a sample class, it's already possible
to use the `nativeImage` task (that is declared by the `io.micronaut.application`
gradle plugin).

[source, shell]
----
$ ./gradlew nativeImage
Starting a Gradle Daemon, 2 incompatible Daemons could not be reused, use --status for details

> Task :nativeImage
[application:5132]    classlist:   2,643.56 ms,  0.96 GB
[application:5132]        (cap):   3,351.71 ms,  0.94 GB
[application:5132]        setup:   5,624.55 ms,  0.94 GB
[application:5132]     (clinit):   1,123.83 ms,  3.87 GB
[application:5132]   (typeflow):  20,613.01 ms,  3.87 GB
[application:5132]    (objects):  25,885.88 ms,  3.87 GB
[application:5132]   (features):   2,753.84 ms,  3.87 GB
[application:5132]     analysis:  52,584.51 ms,  3.87 GB
[application:5132]     universe:   2,365.85 ms,  3.88 GB
[application:5132]      (parse):   6,115.11 ms,  3.88 GB
[application:5132]     (inline):  13,036.22 ms,  5.48 GB
[application:5132]    (compile):  42,139.93 ms,  5.67 GB
[application:5132]      compile:  64,370.44 ms,  5.67 GB
[application:5132]        image:   6,289.82 ms,  5.62 GB
[application:5132]        write:   1,752.41 ms,  5.62 GB
[application:5132]      [total]: 136,033.63 ms,  5.62 GB
Native Image written to: /Users/bric3/opensource/slack-set-profile/build/native-image/application

BUILD SUCCESSFUL in 2m 27s
3 actionable tasks: 1 executed, 2 up-to-date

$ ls -lah build/native-image/application
Permissions Size User  Date Modified Name
.rwxr-xr-x   51M bric3 18 Nov 11:20  build/native-image/application

$ build/native-image/application -h
11:22:37.206 [main] INFO  i.m.context.env.DefaultEnvironment - Established active environments: [cli]
Usage: slack-set-profile [-hvV]
...
  -h, --help      Show this help message and exit.
  -v, --verbose   ...
  -V, --version   Print version information and exit.
----

This generated a binary of 50 MiB that does nothing but prints help.
But, it's a standalone executable.

As expected the native image is around 2 orders of magnitude faster than
starting a cold JVM (with the default options).

.Stupid benchmarks
[source, shell]
----
$ hyperfine "build/native-image/application -h"
Benchmark #1: build/native-image/application -h
  Time (mean ± σ):      22.5 ms ±   3.6 ms    [User: 9.6 ms, System: 9.7 ms]
  Range (min … max):    19.8 ms …  59.9 ms    123 runs

  Warning: Statistical outliers were detected. Consider re-running this benchmark on a quiet PC without any interferences from other programs. It might help to use the '--warmup' or '--prepare' options.

$ hyperfine "java -jar build/libs/slack-set-profile-0.1-all.jar -h"
Benchmark #1: java -jar build/libs/slack-set-profile-0.1-all.jar -h
  Time (mean ± σ):      1.190 s ±  0.025 s    [User: 1.505 s, System: 0.263 s]
  Range (min … max):    1.166 s …  1.244 s    10 runs


----




